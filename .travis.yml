#
# Configuration for travis-ci testing
# This tests ubuntu by default, but can also be made to test on osx
#
sudo: required

# Test on Ubuntu 14
dist: trusty

language: python

matrix:
    # Always put true env variable first, for nicer overview on travis website
    include:
        # Unit tests (Ubuntu)
        - os: linux
          python: "2.7"
          env:
            - MYOKIT_UNIT=true
        - os: linux
          python: "3.4"
          env:
            - MYOKIT_UNIT=true
        - os: linux
          python: "3.5"
          env:
            - MYOKIT_UNIT=true
        - os: linux
          python: "3.6"
          env:
            - MYOKIT_UNIT=true
        # Unit tests on OS/X
        - os: osx
          language: generic
          env:
            - MYOKIT_UNIT=true
        # Cover checking
        - os: linux
          python: "3.6"
          env:
            - MYOKIT_COVER=true
        # Style checking
        - os: linux
          python: "3.6"
          env:
            - MYOKIT_STYLE=true
        # Doctests
        - os: linux
          python: "3.6"
          env:
            - MYOKIT_DOC=true

# Install CVODE dependencies
before_install:
  # Ubuntu
  # Python packages can be installed here but won't work (tests run in virtualenv)
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      sudo apt-get -qq update;
      sudo apt-get install -y libsundials-serial-dev;
    fi
  # OS/X
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      brew cask uninstall oclint;
      brew install sundials;
    fi

# Install Myokit and extra testing dependencies
install:
  - pip install -e .[dev,optional]
  - if [[ $MYOKIT_COVER == true ]]; then pip install coverage codecov; fi;
  - if [[ $MYOKIT_STYLE == true ]]; then pip install flake8; fi;
  - if [[ $MYOKIT_DOC == true ]]; then pip install sphinx; fi;
  - if [[ $MYOKIT_DOC == true ]]; then pip3 install pyqt5; fi;

# Show system information
before_script:
- python -m myokit system

# Run tests
script:
  - if [[ $MYOKIT_UNIT == true ]]; then python test --unit; fi;
  - if [[ $MYOKIT_COVER == true ]]; then coverage run test --nosub; fi;
  - if [[ $MYOKIT_STYLE == true ]]; then python -m flake8; fi;
  - if [[ $MYOKIT_DOC == true ]]; then python test --doctest; fi;

# Compile coverage report
after_success:
  - if [[ $MYOKIT_COVER == true ]]; then codecov; fi;

# Send notifications
notifications:
  email:
    recipients:
    - michael.clerx@cs.ox.ac.uk
